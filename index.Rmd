---
title:  'Computational Musicology'
author: 'Dewi Boessen'
date:   'February--March 2020'
output: 
    flexdashboard::flex_dashboard:
        storyboard: true
        theme: simplex
---

```{r setup}
# In order to use these packages, we need to install flexdashboard, plotly, and Cairo.
library(tidyverse)
library(plotly)
library(spotifyr)
library(compmus)
source('spotify.R')
library(gridExtra)
```


### Carnival Music Differs in Tempo

```{r}
sterre <- get_tidy_audio_analysis("3Anu8IPzrh9GUsOBh04rWn")

sterre %>% 
    tempogram(window_size = 8, hop_size = 1, cyclic = TRUE) %>% 
    ggplot(aes(x = time, y = bpm, fill = power, title = "1000 Sterre")) + 
    geom_raster() + 
    scale_fill_viridis_c(guide = 'none') +
    labs(x = 'Time (s)', y = 'Tempo (BPM)') +
    theme_classic()

zuuje <- 
    get_tidy_audio_analysis('0rSb6Xjxzsus8qJaJ6017S')

zuuje %>% 
    tempogram(window_size = 8, hop_size = 1, cyclic = TRUE) %>% 
    ggplot(aes(x = time, y = bpm, fill = power, title = "Nao 't Zuuje")) + 
    geom_raster() + 
    scale_fill_viridis_c(guide = 'none') +
    labs(x = 'Time (s)', y = 'Tempo (BPM)') +
    theme_classic()

joost <- 
  get_tidy_audio_analysis("7IHqbDM2o7uCpb2SJnijWl")

joost %>% 
    tempogram(window_size = 8, hop_size = 1, cyclic = TRUE) %>% 
    ggplot(aes(x = time, y = bpm, fill = power, title = "Joost")) + 
    geom_raster() + 
    scale_fill_viridis_c(guide = 'none') +
    labs(x = 'Time (s)', y = 'Tempo (BPM)') +
    theme_classic()

zuipschuit <-
  get_tidy_audio_analysis("0kfQVYncHXlHfnRUxkZdk4")

zuipschuit %>% 
    tempogram(window_size = 8, hop_size = 1, cyclic = TRUE) %>% 
    ggplot(aes(x = time, y = bpm, fill = power, title = "De Zuipschuit")) + 
    geom_raster() + 
    scale_fill_viridis_c(guide = 'none') +
    labs(x = 'Time (s)', y = 'Tempo (BPM)') +
    theme_classic()
```

***
For making the tempograms, I used the same songs as before.
What becomes clear is that even though the songs seem to be very similar, the tempi of the songs really differ from each other.

The song *1000 Sterre* has a tempo a bit slower then 140 BPM. In the pre-chorus of the song, there is no drumbeat and this is very clear to see in the tempogram.

The second song, *Nao 't Zuuje*, is a very difficult song for Spotify to define. I think this is due to the fact that the song shifts between two time signatures, 6/8 and 9/8. And the song makes almost no use of drums.

*Joost* is the song with the most clear tempo around 150 BPM. When you listen to the song, you could argue that it has been made with a computer. Personally, this tempogram is an argument to say that this is indeed what happened.

I think that something went wrong in the last tempogram. Because, according to this, there should be an increase in tempo at the end of *De Zuipschuit*. I don't really hear this myself, but that could be something to look into a little bit deeper.



### Carnival Music has a clear structure

```{r}

circshift <- function(v, n) {if (n == 0) v else c(tail(v, n), head(v, -n))}
                                    
    # C     C#    D     Eb    E     F     F#    G     Ab    A     Bb    B 
major_chord <- 
    c(1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    0,    0)
minor_chord <- 
    c(1,    0,    0,    1,    0,    0,    0,    1,    0,    0,    0,    0)
seventh_chord <- 
    c(1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    1,    0)

major_key <- 
    c(6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88)
minor_key <-
    c(6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17)

chord_templates <-
    tribble(
        ~name  , ~template,
        'Gb:7'  , circshift(seventh_chord,  6),
        'Gb:maj', circshift(major_chord,    6),
        'Bb:min', circshift(minor_chord,   10),
        'Db:maj', circshift(major_chord,    1),
        'F:min' , circshift(minor_chord,    5),
        'Ab:7'  , circshift(seventh_chord,  8),
        'Ab:maj', circshift(major_chord,    8),
        'C:min' , circshift(minor_chord,    0),
        'Eb:7'  , circshift(seventh_chord,  3),
        'Eb:maj', circshift(major_chord,    3),
        'G:min' , circshift(minor_chord,    7),
        'Bb:7'  , circshift(seventh_chord, 10),
        'Bb:maj', circshift(major_chord,   10),
        'D:min' , circshift(minor_chord,    2),
        'F:7'   , circshift(seventh_chord,  5),
        'F:maj' , circshift(major_chord,    5),
        'A:min' , circshift(minor_chord,    9),
        'C:7'   , circshift(seventh_chord,  0),
        'C:maj' , circshift(major_chord,    0),
        'E:min' , circshift(minor_chord,    4),
        'G:7'   , circshift(seventh_chord,  7),
        'G:maj' , circshift(major_chord,    7),
        'B:min' , circshift(minor_chord,   11),
        'D:7'   , circshift(seventh_chord,  2),
        'D:maj' , circshift(major_chord,    2),
        'F#:min', circshift(minor_chord,    6),
        'A:7'   , circshift(seventh_chord,  9),
        'A:maj' , circshift(major_chord,    9),
        'C#:min', circshift(minor_chord,    1),
        'E:7'   , circshift(seventh_chord,  4),
        'E:maj' , circshift(major_chord,    4),
        'G#:min', circshift(minor_chord,    8),
        'B:7'   , circshift(seventh_chord, 11),
        'B:maj' , circshift(major_chord,   11),
        'D#:min', circshift(minor_chord,    3))

key_templates <-
    tribble(
        ~name    , ~template,
        'Gb:maj', circshift(major_key,  6),
        'Bb:min', circshift(minor_key, 10),
        'Db:maj', circshift(major_key,  1),
        'F:min' , circshift(minor_key,  5),
        'Ab:maj', circshift(major_key,  8),
        'C:min' , circshift(minor_key,  0),
        'Eb:maj', circshift(major_key,  3),
        'G:min' , circshift(minor_key,  7),
        'Bb:maj', circshift(major_key, 10),
        'D:min' , circshift(minor_key,  2),
        'F:maj' , circshift(major_key,  5),
        'A:min' , circshift(minor_key,  9),
        'C:maj' , circshift(major_key,  0),
        'E:min' , circshift(minor_key,  4),
        'G:maj' , circshift(major_key,  7),
        'B:min' , circshift(minor_key, 11),
        'D:maj' , circshift(major_key,  2),
        'F#:min', circshift(minor_key,  6),
        'A:maj' , circshift(major_key,  9),
        'C#:min', circshift(minor_key,  1),
        'E:maj' , circshift(major_key,  4),
        'G#:min', circshift(minor_key,  8),
        'B:maj' , circshift(major_key, 11),
        'D#:min', circshift(minor_key,  3))

zuuje <- 
    get_tidy_audio_analysis('0rSb6Xjxzsus8qJaJ6017S') %>% 
    compmus_align(sections, segments) %>% 
    select(sections) %>% unnest(sections) %>% 
    mutate(
        pitches = 
            map(segments, 
                compmus_summarise, pitches, 
                method = 'mean', norm = 'manhattan'))

zuuje %>% 
    compmus_match_pitch_template(key_templates, 'euclidean', 'manhattan') %>% 
    ggplot(
        aes(x = start + duration / 2, width = duration, y = name, fill = d)) +
    geom_tile() +
    scale_fill_viridis_c(option = 'E', guide = 'none') +
    theme_minimal() +
    labs(x = 'Time (s)', y = '') + ggtitle("Nao 't Zuuje")

sterre <- 
  get_tidy_audio_analysis("3Anu8IPzrh9GUsOBh04rWn") %>%
    compmus_align(sections, segments) %>% 
    select(sections) %>% unnest(sections) %>% 
    mutate(
        pitches = 
            map(segments, 
                compmus_summarise, pitches, 
                method = 'mean', norm = 'manhattan'))

sterre %>%
  compmus_match_pitch_template(key_templates, 'euclidean', 'manhattan') %>% 
    ggplot(
        aes(x = start + duration / 2, width = duration, y = name, fill = d)) +
    geom_tile() +
    scale_fill_viridis_c(option = 'E', guide = 'none') +
    theme_minimal() +
    labs(x = 'Time (s)', y = '') + ggtitle("1000 Sterre")

joost <- 
  get_tidy_audio_analysis("7IHqbDM2o7uCpb2SJnijWl") %>%
   compmus_align(sections, segments) %>% 
    select(sections) %>% unnest(sections) %>% 
    mutate(
        pitches = 
            map(segments, 
                compmus_summarise, pitches, 
                method = 'mean', norm = 'manhattan'))

joost %>% 
    compmus_match_pitch_template(key_templates, 'euclidean', 'manhattan') %>% 
    ggplot(
        aes(x = start + duration / 2, width = duration, y = name, fill = d)) +
    geom_tile() +
    scale_fill_viridis_c(option = 'E', guide = 'none') +
    theme_minimal() +
    labs(x = 'Time (s)', y = '') + ggtitle("Joost")


zuipschuit <-
  get_tidy_audio_analysis("0kfQVYncHXlHfnRUxkZdk4") %>%
  compmus_align(sections, segments) %>% 
    select(sections) %>% unnest(sections) %>% 
    mutate(
        pitches = 
            map(segments, 
                compmus_summarise, pitches, 
                method = 'mean', norm = 'manhattan'))

zuipschuit %>%
  compmus_match_pitch_template(key_templates, 'euclidean', 'manhattan') %>% 
    ggplot(
        aes(x = start + duration / 2, width = duration, y = name, fill = d)) +
    geom_tile() +
    scale_fill_viridis_c(option = 'E', guide = 'none') +
    theme_minimal() +
    labs(x = 'Time (s)', y = '') + ggtitle("De Zuipschuit")


```

***
I made four keygrams, two for songs from Limburg and two for Brabant. Though the keygrams don't show the right one, you can see the different parts of the songs.
It becomes clear that, despite the fact that carnival music in general is very similar, individual songs show difference in structure.

*Nao 't Zuuje*, for instance, consists of four different parts in which only the last part is different in key. *1000 Sterre* also has four parts, but the chorus couplet structure is clearly visible. Both the keygrams show a lot of yellow.

When you look at the keygrams for the songs from Brabant, you see a lot more blue. *Joost* consists of three parts; the small yellow part, the middle and the modulation at the end of the song. *De Zuipschuit* shows four parts. I don't think it is possible to tell in which key this song is made, but in the middle something else is happening. At the end, there are a lot of changes.

### Carnival Music Is Much More Alike Than Today's Top Hits.

I would like to compare Dutch Carnival Music to Today's Top Hits. I think this is interesting because, in my opinion, carnival music always gets people in a good mood. I also think it's interesting because the genres, subjects and even the vibes are very different. A lot of people can sing along to the songs in both the playlists. I'm very curious to see what's the difference between the two.

```{r}
limburg <- get_playlist_audio_features('Henk Theunissen', '1xQvcNKQVMGOsuZK6nXx9a')
brabant <- get_playlist_audio_features('Dewi Boessen', '5HTIYp3LELNnuvgUSByL9I')

carnaval <-
  limburg %>% mutate(playlist = "Limburg") %>%
  bind_rows(brabant %>% mutate(playlist = "Brabant"))

todayshits <- get_playlist_audio_features('Soave', '5iKY71w39zY0Bs6kcmOK2Z')

muziek <- carnaval %>% mutate(playlist = "Carnaval") %>% bind_rows(todayshits %>% mutate(playlist = "Hits in Nederland 2020"))


vergelijking <- muziek %>%                       # Start with awards.
  mutate(
    mode = ifelse(mode == 0, 'Minor', 'Major')
  ) %>%
  ggplot(                      # Set up the plot.
    aes(
      x = valence,
      y = energy,
      size = loudness,
      colour = mode, label = track.name
    )
  ) +
  geom_point() +               # Scatter plot.
  geom_rug(size = 0.1) +       # Add 'fringes' to show data distribution.
  facet_wrap(~ playlist) +     # Separate charts per playlist.
  scale_x_continuous(          # Fine-tune the x axis.
    limits = c(0, 1),
    breaks = c(0, 0.50, 1),  # Use grid-lines for quadrants only.
    minor_breaks = NULL      # Remove 'minor' grid-lines.
  ) +
  scale_y_continuous(          # Fine-tune the y axis in the same way.
    limits = c(0, 1),
    breaks = c(0, 0.50, 1),
    minor_breaks = NULL
  ) +
  scale_colour_brewer(         # Use the Color Brewer to choose a palette.
    type = "qual",           # Qualitative set.
    palette = "Set3"       # Name of the palette is 'Paired'.
  ) +
  scale_size_continuous(       # Fine-tune the sizes of each point.
    trans = "exp",           # Use an exp transformation to emphasise loud.
    guide = "none"           # Remove the legend for size.
  ) +
  theme_light() +              # Use a simpler them.
  labs(                        # Make the titles nice.
    x = "Valence",
    y = "Energy",
    colour = "Mode"
  )

ggplotly(vergelijking)

carnavall <- carnaval %>%                       # Start with awards.
  mutate(
    mode = ifelse(mode == 0, 'Minor', 'Major')
  ) %>%
  ggplot(                      # Set up the plot.
    aes(
      x = valence,
      y = danceability,
      size = loudness,
      colour = playlist, label = track.name,
      title = "Carnival Music vs. Current Hits in The Netherlands"
    )
  ) +
  geom_point() +               # Scatter plot.
  geom_rug(size = 0.1) +       # Add 'fringes' to show data distribution.     
  scale_x_continuous(          # Fine-tune the x axis.
    limits = c(0, 1),
    breaks = c(0, 0.50, 1),  # Use grid-lines for quadrants only.
    minor_breaks = NULL      # Remove 'minor' grid-lines.
  ) +
  scale_y_continuous(          # Fine-tune the y axis in the same way.
    limits = c(0, 1),
    breaks = c(0, 0.50, 1),
    minor_breaks = NULL
  ) +
  scale_colour_brewer(         # Use the Color Brewer to choose a palette.
    type = "qual",           # Qualitative set.
    palette = "Set3"       # Name of the palette is 'Paired'.
  ) +
  scale_size_continuous(       # Fine-tune the sizes of each point.
    trans = "exp",           # Use an exp transformation to emphasise loud.
    guide = "none"           # Remove the legend for size.
  ) +
  theme_light() +              # Use a simpler them.
  labs(                        # Make the titles nice.
    x = "Valence",
    y = "Danceability",
    colour = "Playlist"
  )

ggplotly(carnavall)

```

***
Audio Feature   |Carnavival Music    |Hits in The Netherlands|
--------------------------------------------------------------
Acousticness    |M = 0.213 SD = 0.173|M = 0.291 SD = 0.272   |
Danceability    |M = 0.669 SD = 0.135|M = 0.665 SD = 0.123   |
Energy          |M = 0.841 SD = 0.109|M = 0.619 SD = 0.163   |
Instrumentalness|M = 0.008 SD = 0.059|M = 0.009 SD = 0.067   |
Liveness        |M = 0.250 SD = 0.198|M = 0.155 SD = 0.121   |
Loudness        |M = -5.44 SD = 1.66 |M = -6.38 SD = 2.45    |
Speechiness     |M = 0.084 SD = 0.065|M = 0.086 SD = 0.081   |
Valence         |M = 0.792 SD = 0.180|M = 0.511 SD = 0.220   |
Mode            |M = 0.876 SD = 0.330|M = 0.630 SD = 0.485   |


***
For my corpus, I used different Spotify playlists, playlists like Vastelaovend 2020 and Carnaval Brabant for the carnival music and Nederlandse Hits 2020 for the songs that are popular in the Netherlands at the moment. To make it a little bit more easier, I decided to put the music from Limburg and Brabant in one playlist. The playlists consist of songs that are currently most popular. As measured by Spotify, carnival music has a much higher valence (M = 0.792, SD = 0.180) than the top hits (M = 0.511, SD = 0.220). The mode of carnival music, overall, seems to be more major (M = 0.876, SD = 0.330) than the top hits (M = 0.630, SD = 0.485). The carnival music also has a much higher energy (M = 0.841, SD = 0.109), compared to the hits (M = 0.619, SD = 0.163).


***

Carnival, in Dutch Carnaval or Vastelaovend, is a holiday consisting of three days full of dressing up and drinking lots and lots of alcohol. (here needs some more information)


### Carnaval Music Is More Positive






***

In the visualisation, you can see that the popular songs in the Netherlands are more spread over the axis. The carnival music tends to have a very high energy and a high valence. Ofcourse, there are some outliers. But overall, it seems like the carnival music is much more energetic and positive than the hitsongs. Carnival music also seems to be very similar because most of the songs are in the same area of the plot.

I used a couple of Spotify's features. On the *x* axis, 'valance' is shown and on the *y* axis shows 'energy'. The colour of the dots clarifies whether the songs are in a major or in a minor mode and the size of the dots gives us an idea about the loudness of the songs in the playlists.


The music tends to be happier and this could contribute to the fact that when celebrating carnival, most people are in a very good mood. But ofcourse, we can't forget the large consumption of alcoholic drinks.


### Limburg vs. Brabant

```{r}
beppie <- 
    get_tidy_audio_analysis('4M2tPMJdLldCKDhBZGLR9t') %>% 
    select(segments) %>% unnest(segments) %>% 
    compmus_c_transpose('D#') %>% 
    select(start, duration, pitches)
rene <- 
    get_tidy_audio_analysis('7drS8Zj5rq3usSZY1e5crj') %>% 
    select(segments) %>% unnest(segments) %>%
    compmus_c_transpose('A') %>%
    select(start, duration, pitches)

beppie %>% 
    mutate(pitches = map(pitches, compmus_normalise, 'euclidean')) %>% 
    compmus_gather_chroma %>% 
    ggplot(
        aes(
            x = start + duration / 2, 
            width = duration, 
            y = pitch_class, 
            fill = value)) + 
    geom_tile() +
    labs(x = 'Time (s)', y = NULL, fill = 'Magnitude') +
    theme_minimal()

rene %>% 
    mutate(pitches = map(pitches, compmus_normalise, 'euclidean')) %>% 
    compmus_gather_chroma %>% 
    ggplot(
        aes(
            x = start + duration / 2, 
            width = duration, 
            y = pitch_class, 
            fill = value)) + 
    geom_tile() +
    labs(x = 'Time (s)', y = NULL, fill = 'Magnitude') +
    theme_minimal()

compmus_long_distance(
    beppie %>% mutate(pitches = map(pitches, compmus_normalise, 'chebyshev')),
    rene %>% mutate(pitches = map(pitches, compmus_normalise, 'chebyshev')),
    feature = pitches,
    method = 'euclidean') %>% 
    ggplot(
        aes(
            x = xstart + xduration / 2, 
            width = xduration,
            y = ystart + yduration / 2,
            height = yduration,
            fill = d)) + 
    geom_tile() +
    scale_fill_continuous(type = 'viridis', guide = 'none') +
    labs(x = 'Beppie Kraft', y = 'Rene Schuurmans') +
    theme_minimal() +
  coord_equal()

```

***

Because there is a language difference in the music from Brabant and Limburg, I thought it'd be interesting to compare a song. Sometimes artists make covers of songs that are popular in the other county. In this case I choose the song *Laot de zon in dien hart* and *Laat de zon in je hart*, which means let the sun into your heart. When you listen to the tracks, the two versions seem to be very alike.

```{r}

beppie <- get_track_audio_features('4M2tPMJdLldCKDhBZGLR9t')
rene <- get_track_audio_features('7drS8Zj5rq3usSZY1e5crj')

``` 
|Audio Feature    |Rene Schuurmans|Beppie Kraft|
|-----------------|---------------|------------|
|Danceability     |0.731	        |0.786       |
|Energy	          |0.807	        |0.791       |
|Key	            |9	            |3           |
|Loudness         |-5.508	        |-6.294      |
|Mode	            |1              |1           |
|Speechiness      |0.0289	        |0.0279      |
|Acousticness	    |0.636          |0.431       |
|Instrumentalness	|0	            |0           |
|Liveness	        |0.275	        |0.332       |
|Valence	        |0.963	        |0.939       |
|Tempo	          |123.986	      |123.94      |

As becomes clear from the table, the only big difference between the two songs is the 'loudness' feature and the key. The version of Rene Schuurmans is in A major and the version of Beppie Kraft is in D# major.

I think the reason that the graph is so blurry is because the songs are in different keys, but I am not sure and I don't know how to fix it.

### *1000 Sterre* is repetitive 

```{r}

sterre <- 
    get_tidy_audio_analysis('2belCUvfatuYkLvppS4EVV') %>% 
    compmus_align(bars, segments) %>% 
    select(bars) %>% unnest(bars) %>% 
    mutate(
        pitches = 
            map(segments, 
                compmus_summarise, pitches, 
                method = 'rms', norm = 'euclidean')) %>% 
    mutate(
        timbre = 
            map(segments, 
                compmus_summarise, timbre, 
                method = 'mean'))

sterre %>% 
    compmus_gather_timbre %>% 
    ggplot(
        aes(
            x = start + duration / 2, 
            width = duration, 
            y = basis, 
            fill = value)) + 
    geom_tile() +
    labs(x = 'Time (s)', y = NULL, fill = 'Magnitude') +
    scale_fill_viridis_c(option = 'E') +
    theme_classic()

sterre %>% 
    compmus_self_similarity(timbre, 'cosine') %>% 
    ggplot(
        aes(
            x = xstart + xduration / 2, 
            width = xduration,
            y = ystart + yduration / 2,
            height = yduration,
            fill = d)) + 
    geom_tile() +
    coord_fixed() +
    scale_fill_viridis_c(option = 'E', guide = 'none') +
    theme_classic() +
    labs(x = '', y = '') + ggtitle("Timbre")

sterre_chroma <- get_tidy_audio_analysis("2belCUvfatuYkLvppS4EVV") %>%
  compmus_align(bars, segments) %>%
  select(bars) %>% unnest(bars) %>%
  mutate(
    pitches =
      map(segments,
          compmus_summarise, pitches,
          method = 'mean', norm = 'manhattan')) %>%
  mutate(
    chroma =
      map(segments,
          compmus_summarise, timbre,
          method = 'mean'))

sterre_chroma %>% 
    compmus_self_similarity(chroma, 'manhattan') %>% 
    ggplot(
        aes(
            x = xstart + xduration / 2, 
            width = xduration,
            y = ystart + yduration / 2,
            height = yduration,
            fill = d)) + 
    geom_tile() +
    coord_fixed() +
    scale_fill_viridis_c(option = 'E', guide = 'none') +
    theme_classic() +
    labs(x = '', y = '') + ggtitle("Chroma")

```

***

For the self similarity matrices, I choose the song *1000 Sterre* by Bjorn & Mieke. It is one of the song I like the most. There is a clear pattern visable and it shows that the song is repetitive. I also choose bars as level of detail, because this gave the most clear matrix.

I wasn't able to make the chroma self similarity matrix work and because of that I could not compare the timbre on to the chroma one. I hope this is not a problem.
